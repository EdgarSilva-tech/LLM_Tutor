name: E2E (Minikube)

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ main ]

permissions:
  contents: read
  packages: read

jobs:
  e2e:
    runs-on: ubuntu-latest
    env:
      NAMESPACE: llm-tutor

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: pip

      - name: Install test deps
        run: pip install -r requirements.txt

      - name: Setup Minikube
        uses: medyagh/setup-minikube@latest
        with:
          minikube-version: 'latest'
          kubernetes-version: 'v1.29.0'
          driver: docker
          addons: ingress

      - name: Create namespace
        run: kubectl create namespace $NAMESPACE || true

      - name: GHCR pull secret (regcred)
        run: |
          kubectl -n $NAMESPACE create secret docker-registry regcred \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --docker-email=edgardasilva10@hotmail.com \
            --dry-run=client -o yaml | kubectl apply -f -

      # Deploy RabbitMQ using official image (replaces Bitnami chart)
      - name: Deploy RabbitMQ (official image)
        run: |
          cat <<'YAML' | kubectl -n $NAMESPACE apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: rabbitmq
          spec:
            selector:
              app: rabbitmq
            ports:
              - name: amqp
                port: 5672
                targetPort: 5672
              - name: mgmt
                port: 15672
                targetPort: 15672
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: rabbitmq
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: rabbitmq
            template:
              metadata:
                labels:
                  app: rabbitmq
              spec:
                containers:
                  - name: rabbitmq
                    image: rabbitmq:3.13-management-alpine
                    ports:
                      - containerPort: 5672
                      - containerPort: 15672
                    env:
                      - name: RABBITMQ_DEFAULT_USER
                        value: "appuser"
                      - name: RABBITMQ_DEFAULT_PASS
                        value: "apppass"
                      - name: RABBITMQ_DEFAULT_VHOST
                        value: "/"
                      - name: RABBITMQ_URL
                        value: "amqp://appuser:apppass@rabbitmq:5672/%2F"
                    readinessProbe:
                      tcpSocket:
                        port: 5672
                      initialDelaySeconds: 10
                      periodSeconds: 5
                    livenessProbe:
                      tcpSocket:
                        port: 5672
                      initialDelaySeconds: 20
                      periodSeconds: 10
          YAML

      - name: Wait for RabbitMQ
        run: |
          kubectl -n $NAMESPACE rollout status deploy/rabbitmq --timeout=300s
          kubectl -n $NAMESPACE get svc rabbitmq

      - name: Deploy Postgres (ephemeral)
        run: |
          cat <<'YAML' | kubectl -n $NAMESPACE apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: postgres
          spec:
            selector:
              app: postgres
            ports:
              - port: 5432
                targetPort: 5432
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: postgres
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: postgres
            template:
              metadata:
                labels:
                  app: postgres
              spec:
                containers:
                  - name: postgres
                    image: postgres:16-alpine
                    env:
                      - name: POSTGRES_DB
                        value: "${{ secrets.DB_NAME }}"
                      - name: POSTGRES_PASSWORD
                        value: "${{ secrets.PG_PASSWORD }}"
                    ports:
                      - containerPort: 5432
                    readinessProbe:
                      tcpSocket: { port: 5432 }
                      initialDelaySeconds: 10
                      periodSeconds: 5
                    livenessProbe:
                      tcpSocket: { port: 5432 }
                      initialDelaySeconds: 20
                      periodSeconds: 10
          YAML

      - name: Wait for Postgres
        run: kubectl -n $NAMESPACE rollout status deploy/postgres --timeout=300s

      - name: Initialize application databases
        env:
          PGPASSWORD: ${{ secrets.PG_PASSWORD }}
        run: |
          # Create required databases if they don't exist
          kubectl -n $NAMESPACE run psql-init --rm -i --image=postgres:16-alpine --restart=Never --env="PGPASSWORD=$PGPASSWORD" -- \
            sh -lc '
              until pg_isready -h postgres -p 5432 -U postgres; do echo "waiting for postgres"; sleep 2; done;
              create_db() { db="$1"; exists=$(psql -tAc "SELECT 1 FROM pg_database WHERE datname='\''$db'\''" -h postgres -p 5432 -U postgres -d postgres); if [ "$exists" != "1" ]; then psql -h postgres -p 5432 -U postgres -d postgres -c "CREATE DATABASE \\"$db\\""; else echo "DB $db exists"; fi; }
              create_db "Users"
              create_db "Evaluation"
              create_db "Khan_Academy"
            '

      # Recommendation 1: print debug info if RabbitMQ fails
      - name: Debug RabbitMQ (on failure)
        if: failure()
        run: |
          kubectl -n $NAMESPACE get pods -o wide
          kubectl -n $NAMESPACE describe pod -l app=rabbitmq
          kubectl -n $NAMESPACE logs -l app=rabbitmq --tail=200

      - name: Apply config/secrets/ingress
        run: |
          kubectl -n $NAMESPACE apply -f k8s/app-config.yaml
          kubectl -n $NAMESPACE apply -f k8s/ingress-apis.yaml

      - name: Create app-secrets from GitHub Secrets
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          PG_PASSWORD: ${{ secrets.PG_PASSWORD }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPIK_API_KEY: ${{ secrets.OPIK_API_KEY }}
          REDIS_ENDPOINT: ${{ secrets.REDIS_ENDPOINT }}
          REDIS_PORT: 10279
          REDIS_USERNAME: default
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          RABBITMQ_USER: ${{ secrets.RABBITMQ_USER }}
          RABBITMQ_PASS: ${{ secrets.RABBITMQ_PASS }}
          HOST: postgres
          USERNAME: postgres
        run: |
          kubectl -n $NAMESPACE create secret generic app-secrets \
            --from-literal=SECRET_KEY="$SECRET_KEY" \
            --from-literal=AUTH_SECRET="$AUTH_SECRET" \
            --from-literal=PG_PASSWORD="$PG_PASSWORD" \
            --from-literal=OPENAI_API_KEY="$OPENAI_API_KEY" \
            --from-literal=OPIK_API_KEY="$OPIK_API_KEY" \
            --from-literal=REDIS_ENDPOINT="$REDIS_ENDPOINT" \
            --from-literal=REDIS_PORT="$REDIS_PORT" \
            --from-literal=REDIS_USERNAME="$REDIS_USERNAME" \
            --from-literal=REDIS_PASSWORD="$REDIS_PASSWORD" \
            --from-literal=RABBITMQ_USER="$RABBITMQ_USER" \
            --from-literal=RABBITMQ_PASS="$RABBITMQ_PASS" \
            --from-literal=HOST="$HOST" \
            --from-literal=USERNAME="$USERNAME" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy services
        run: |
          kubectl -n $NAMESPACE apply -f k8s/auth.yaml
          kubectl -n $NAMESPACE apply -f k8s/quizz.yaml
          kubectl -n $NAMESPACE apply -f k8s/quiz-generator-consumer.yaml
          kubectl -n $NAMESPACE apply -f k8s/evaluation.yaml
          kubectl -n $NAMESPACE apply -f k8s/rag.yaml
        # Avoid applying CRDs/resources for KEDA in CI unless you install the operator

      - name: Scale down replicas for CI
        run: |
          for d in auth-service quizz-service quiz-generator-consumer evaluation-service rag-service; do
            kubectl -n $NAMESPACE scale deploy/$d --replicas=1 || true
          done

      - name: Increase auth-service readiness initialDelay
        run: |
          kubectl -n $NAMESPACE patch deploy/auth-service --type='json' -p='[
            {"op":"replace","path":"/spec/template/spec/containers/0/readinessProbe/initialDelaySeconds","value":60}
          ]' || true

      - name: Use Recreate strategy for auth-service (avoid stuck old pods)
        run: |
          kubectl -n $NAMESPACE patch deploy/auth-service --type='merge' -p '{
            "spec": { "strategy": { "type": "Recreate" } }
          }' || true
          # Reduce termination grace to unblock rollouts in CI
          kubectl -n $NAMESPACE patch deploy/auth-service --type='json' -p='[
            {"op":"add","path":"/spec/template/spec/terminationGracePeriodSeconds","value":10}
          ]' || true

      - name: Forceâ€‘delete any Terminating auth-service pods (safety)
        run: |
          kubectl -n $NAMESPACE get pods -l app=auth-service || true
          kubectl -n $NAMESPACE delete pod -l app=auth-service --field-selector=status.phase=Failed --ignore-not-found=true || true
          kubectl -n $NAMESPACE delete pod -l app=auth-service --field-selector=status.phase=Unknown --ignore-not-found=true || true
          kubectl -n $NAMESPACE delete pod -l app=auth-service --field-selector=status.phase=Terminating --grace-period=0 --force || true

      - name: Override DB port for CI
        run: |
          for d in auth-service quizz-service quiz-generator-consumer evaluation-service rag-service; do
            kubectl -n $NAMESPACE set env deploy/$d DB_PORT=5432 || true
          done

      - name: Wait for rollouts
        run: |
          kubectl -n $NAMESPACE rollout status deploy/auth-service --timeout=600s
          kubectl -n $NAMESPACE rollout status deploy/quizz-service --timeout=300s
          kubectl -n $NAMESPACE rollout status deploy/quiz-generator-consumer --timeout=300s
          kubectl -n $NAMESPACE rollout status deploy/evaluation-service --timeout=300s
          kubectl -n $NAMESPACE rollout status deploy/rag-service --timeout=300s

      - name: Export E2E_BASE_URL from Ingress
        run: echo "E2E_BASE_URL=$(minikube service -n ingress-nginx ingress-nginx-controller --url | head -n1)" >> $GITHUB_ENV

      - name: Run E2E tests
        env:
          E2E_BASE_URL: ${{ env.E2E_BASE_URL }}
          E2E_USERNAME: ${{ secrets.E2E_USERNAME }}
          E2E_PASSWORD: ${{ secrets.E2E_PASSWORD }}
        run: pytest -m e2e -q
