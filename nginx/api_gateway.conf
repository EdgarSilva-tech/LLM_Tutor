# nginx/api_gateway.conf

# Rate limiting zone
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

# Upstream definitions
upstream auth_service {
    server auth_service:8001;
}

upstream rag_service {
    server rag_service:8002;
}

upstream evaluation_service {
    server evaluation_service:8003;
}

upstream quiz_service {
    server quiz_service:8004;
}

# Map for extracting JWT token
map $http_authorization $auth_token {
    "~*^bearer (.+)$" $1;
    default "";
}

server {
    listen 80;
    server_name localhost;

    # Headers for proxy
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Public endpoints (no authentication required)
    location /auth/login {
        limit_req zone=api burst=10 nodelay;
        proxy_pass http://auth_service/token;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    location /auth/verify {
        limit_req zone=api burst=10 nodelay;
        proxy_pass http://auth_service/verify-token;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Protected endpoints - validate JWT before forwarding
    location /rag/ {
        # Validate JWT token
        auth_request /auth/validate;
        
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://rag_service/;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_set_header Authorization $http_authorization;
    }

    location /eval/ {
        # Validate JWT token
        auth_request /auth/validate;
        
        limit_req zone=api burst=15 nodelay;
        proxy_pass http://evaluation_service/;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        proxy_set_header Authorization $http_authorization;
    }

    location /quiz/ {
        # Validate JWT token
        auth_request /auth/validate;
        
        limit_req zone=api burst=15 nodelay;
        proxy_pass http://quiz_service/;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        proxy_set_header Authorization $http_authorization;
    }

    # Internal token validation endpoint
    location = /auth/validate {
        internal;
        proxy_pass http://auth_service/verify-token;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header Authorization $http_authorization;
    }

    # Health check (no auth required)
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}